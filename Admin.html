<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Panel de Control - Mapa en Vivo</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100vh; background-color: #e5e5e5; }
        .marker {
            width: 20px;
            height: 20px;
            background-color: #ff0000;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id='map'></div>

    <script>
        // 1. CONFIGURACIÓN
        mapboxgl.accessToken = 'pk.eyJ1IjoibHVjc2lsdmExMzEwIiwiYSI6ImNtbGlyNW9lODA2Y3gzZm9wazBnemNiMGIifQ.cuc584I8qpAKDU9-KUaYWw'; 
        const supabaseUrl = 'https://bimhfmxsikxyeaukfvbe.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpbWhmbXhzaWt4eWVhdWtmdmJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODA2MTMsImV4cCI6MjA4NjE1NjYxM30.Q4Hydin8FSNIPd02Cl3e7RUSX6a_aEwJHBuh-Jwhmtg';
        
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Inicializar el mapa
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-66.903, 10.480], // Centro inicial (Caracas)
            zoom: 12
        });

        const marcadores = {};

        // Función para crear o mover marcadores
        function actualizarMarcador(repartidor) {
            const { id, lat, lng, nombre } = repartidor;

            // Validar que tengamos coordenadas válidas
            if (!lat || !lng) return;

            if (marcadores[id]) {
                // Si ya existe, solo moverlo
                marcadores[id].setLngLat([lng, lat]);
            } else {
                // Si no existe, crear el elemento HTML del marcador
                const el = document.createElement('div');
                el.className = 'marker';
                
                // Crear y añadir el marcador al mapa
                marcadores[id] = new mapboxgl.Marker(el)
                    .setLngLat([lng, lat])
                    .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`<h3>Repartidor #${id}</h3>`))
                    .addTo(map);
                
                // Opcional: Centrar el mapa en el primer marcador que aparezca
                map.flyTo({ center: [lng, lat], zoom: 14 });
            }
        }

        // 2. CARGAR DATOS INICIALES (Para que no aparezca vacío al abrir)
        async function cargarIniciantes() {
            const { data, error } = await supabaseClient
                .from('repartidores')
                .select('*');

            if (error) {
                console.error("Error cargando datos iniciales:", error.message);
                return;
            }

            if (data) {
                data.forEach(repartidor => {
                    actualizarMarcador(repartidor);
                });
            }
        }

        // 3. ESCUCHAR CAMBIOS EN TIEMPO REAL
        supabaseClient
            .channel('repartidores-tracker')
            .on('postgres_changes', 
                { event: 'UPDATE', schema: 'public', table: 'repartidores' }, 
                (payload) => {
                    console.log('Cambio recibido:', payload.new);
                    actualizarMarcador(payload.new);
                }
            )
            .subscribe();

        // Ejecutar carga inicial
        cargarIniciantes();

    </script>
</body>
</html>
